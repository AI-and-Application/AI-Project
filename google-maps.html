<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Navigation</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=(redacted)&libraries=places"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      height: 85%;
      width: 100%;
    }
    #controls {
      height: 15%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f8f8f8;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 10px;
    }
    input, button {
      margin: 0 10px;
      padding: 10px;
      font-size: 14px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    #instructions {
      padding: 10px;
      font-size: 14px;
      max-height: 100px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ddd;
      margin-top: 5px;
    }
  </style>
</head>
<body>
<div id="controls">
  <input id="start" type="text" placeholder="Enter start location">
  <input id="end" type="text" placeholder="Enter destination">
  <button onclick="startNavigation()">Start Navigation</button>
</div>
<div id="map"></div>
<div id="instructions"></div>

<script>
  let map, directionsService, directionsRenderer, currentPositionMarker;
  let navigationInterval;
  let steps = [];
  let currentStepIndex = 0;

  // Initialize map
  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 37.7749, lng: -122.4194 }, // Default center
      zoom: 14,
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

    // Autocomplete for start and end inputs
    const startInput = document.getElementById("start");
    const endInput = document.getElementById("end");
    const startAutocomplete = new google.maps.places.Autocomplete(startInput);
    const endAutocomplete = new google.maps.places.Autocomplete(endInput);
  }

  // Start navigation
  function startNavigation() {
    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;

    if (!start || !end) {
      alert("Please provide both a start and destination.");
      return;
    }

    // Get directions
    const request = {
      origin: start,
      destination: end,
      travelMode: google.maps.TravelMode.DRIVING,
    };

    directionsService.route(request, (result, status) => {
      if (status === google.maps.DirectionsStatus.OK) {
        directionsRenderer.setDirections(result);
        steps = result.routes[0].legs[0].steps;
        displayInstructions(steps);

        // Start real-time tracking
        if (navigationInterval) clearInterval(navigationInterval);
        navigationInterval = setInterval(trackLocation, 5000); // Update every 5 seconds
      } else {
        alert("Could not calculate route: " + status);
      }
    });
  }

  // Display instructions
  function displayInstructions(steps) {
    const instructionsDiv = document.getElementById("instructions");
    instructionsDiv.innerHTML = "";
    steps.forEach((step, index) => {
      instructionsDiv.innerHTML += `<p><strong>Step ${index + 1}:</strong> ${step.instructions} (${step.distance.text})</p>`;
    });
  }

  // Track user's current location
  function trackLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };

          // Update marker
          if (currentPositionMarker) {
            currentPositionMarker.setPosition(userLocation);
          } else {
            currentPositionMarker = new google.maps.Marker({
              position: userLocation,
              map: map,
              title: "You are here",
              icon: {
                url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
              },
            });
          }

          map.panTo(userLocation);

          // Check if the user is near the next step
          checkProximity(userLocation);
        },
        (error) => {
          console.error("Error getting location: ", error);
        }
      );
    } else {
      alert("Geolocation is not supported by your browser.");
    }
  }

  // Check proximity to next step
  function checkProximity(userLocation) {
    if (currentStepIndex >= steps.length) {
      clearInterval(navigationInterval);
      alert("You have reached your destination!");
      return;
    }

    const step = steps[currentStepIndex];
    const stepLocation = step.start_location;

    const distance = calculateDistance(
      userLocation.lat,
      userLocation.lng,
      stepLocation.lat(),
      stepLocation.lng()
    );

    if (distance < 50) { // If user is within 50 meters of the step
      alert(`Upcoming: ${step.instructions}`);
      currentStepIndex++;
    }
  }

  // Calculate distance between two points (Haversine formula)
  function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371e3; // Earth's radius in meters
    const φ1 = (lat1 * Math.PI) / 180;
    const φ2 = (lat2 * Math.PI) / 180;
    const Δφ = ((lat2 - lat1) * Math.PI) / 180;
    const Δλ = ((lng2 - lng1) * Math.PI) / 180;

    const a =
      Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
      Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    return R * c; // Distance in meters
  }

  // Initialize map on window load
  window.onload = initMap;
</script>
</body>
</html>
